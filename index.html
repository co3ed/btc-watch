<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>₿ BTC Top/Bottom Watch</title>
<style>
:root{--bg:#0e1117;--card:#141a23;--text:#e9eef5;--muted:#9aa4b2;--ring:#222a39;--green:#1fbf75;--amber:#f5a524;--red:#ea3943;--line:#1f2532}
*{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}
.wrap{max-width:980px;margin:0 auto;padding:16px}
.bar{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:12px}
h1{font-size:18px;margin:0}
.stamp{font-size:12px;color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:920px){.grid{grid-template-columns:1.2fr .8fr}}
.card,.k{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
.k{margin-bottom:10px}
.gaugeWrap{position:relative;display:flex;flex-direction:column;align-items:center}
.gLabel{position:absolute;bottom:52px;text-align:center;font-weight:700;font-size:13px;color:var(--muted)}
.verdict{position:absolute;bottom:18px;text-align:center;font-weight:900;font-size:32px;letter-spacing:.3px}
.buy{color:var(--green)} .hold{color:var(--amber)} .sell{color:var(--red)}
.bigline{display:flex;gap:10px;align-items:baseline;justify-content:center;margin-top:10px}
.bigline .p{font-size:24px;font-weight:800}
.bigline .d{font-size:13px;color:var(--muted)}
.pill{padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800;border:1px solid transparent;min-width:84px;text-align:center}
.green{background:rgba(31,191,117,.12);color:var(--green);border-color:rgba(31,191,117,.35)}
.amber{background:rgba(245,165,36,.12);color:var(--amber);border-color:rgba(245,165,36,.35)}
.red{background:rgba(234,57,67,.12);color:var(--red);border-color:rgba(234,57,67,.35)}
.row{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
.barFill{height:10px;background:linear-gradient(90deg,#1fbf75,#f5a524,#ea3943);border-radius:8px}
.bar{background:#0f1420;border:1px solid var(--line);border-radius:8px;padding:6px}
.hint{margin-top:6px;color:var(--muted);font-size:12px}
footer{color:#9aa4b2;font-size:12px;margin-top:10px;text-align:center}
#error{display:none;margin-top:10px;padding:10px;border:1px solid #8b1e1e;border-radius:8px;background:#2a1111;color:#ffb4b4;font-size:12px;white-space:pre-wrap}
.small{font-size:11px;color:var(--muted);margin-top:6px}
/* smooth needle */
#needle{transition:transform .6s cubic-bezier(.2,.8,.2,1)}
</style>
</head>
<body>
  <div class="wrap">
    <header class="bar">
      <h1>₿ BTC Top/Bottom Watch</h1>
      <div class="stamp">Updated <span id="ts">—</span> UTC</div>
    </header>

    <main class="grid">
      <section class="card">
        <div class="gaugeWrap">
          <svg id="gauge" viewBox="0 0 240 160" width="100%" style="max-width:680px">
            <path d="M30 130 A90 90 0 0 1 210 130" fill="none" stroke="var(--ring)" stroke-width="22" stroke-linecap="round"/>
            <path d="M30 130 A90 90 0 0 1 90 60" fill="none" stroke="var(--green)" stroke-width="22" stroke-linecap="round"/>
            <path d="M90 60 A90 90 0 0 1 150 60" fill="none" stroke="var(--amber)" stroke-width="22" stroke-linecap="round"/>
            <path d="M150 60 A90 90 0 0 1 210 130" fill="none" stroke="var(--red)" stroke-width="22" stroke-linecap="round"/>
            <circle cx="120" cy="130" r="6" fill="#e9eef5"/>
            <g id="needle" transform="rotate(-90,120,130)">
              <path d="M120 130 L120 34" stroke="#e9eef5" stroke-width="3"/>
              <circle cx="120" cy="34" r="4" fill="#e9eef5"/>
            </g>
          </svg>
          <div class="gLabel">Cycle Heat (0–10)</div>
          <div id="verdict" class="verdict hold">HOLD</div>
        </div>

        <div class="bigline">
          <div class="p" id="price">£ —  $ —</div>
          <div class="d" id="change">24h: —</div>
        </div>

        <div id="error"></div>
        <div id="netnote" class="small"></div>
      </section>

      <aside>
        <div class="k">
          <div class="t">Verdict</div>
          <div class="v"><span id="verdictPill" class="pill amber">HOLD</span></div>
        </div>

        <div class="k">
          <div class="t">Quick View</div>
          <div class="row"><span>Trend vs 200-day</span><span id="trend" class="pill amber">—</span></div>
          <div class="row"><span>RSI (Weekly)</span><span id="rsiw" class="pill amber">—</span></div>
          <div class="row"><span>Funding (8h)</span><span id="fund" class="pill amber">—</span></div>
          <div class="row"><span>Fear & Greed</span><span id="fg" class="pill amber">—</span></div>
          <div class="row"><span>Pi Cycle</span><span id="pi" class="pill amber">—</span></div>
        </div>

        <div class="k">
          <div class="t">Cycle Bar (0–100)</div>
          <div class="bar"><div id="cycleFill" class="barFill" style="width:0%"></div></div>
          <div class="hint">0–25 Bear · 26–75 Bull · 76–100 Peak</div>
        </div>
      </aside>
    </main>

    <footer>0–3 = BUY · 4–6 = HOLD · 7–10 = SELL · (Data: Binance WS + CoinGecko + Binance Funding + alt.me F&G)</footer>
  </div>

<script>
/*** CONFIG ***/
const FAST_MS = 10_000;          // backup price/24h change
const SLOW_MS = 60*60_000;       // indicators refresh
const BACKOFF = 30_000;          // retry delay
const PROXIES = [
  "https://cors.isomorphic-git.org/",
  "https://thingproxy.freeboard.io/fetch/"
];

/*** ENDPOINTS ***/
const priceUrl = (t=Date.now()) =>
  `https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd,gbp&include_24hr_change=true&_=${t}`;
const chartUrl = (t=Date.now()) =>
  `https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=365&interval=daily&_=${t}`;
const fundUrl  = (t=Date.now()) =>
  `https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=1&_=${t}`;
const fngUrl   = (t=Date.now()) =>
  `https://api.alternative.me/fng/?limit=1&date_format=us&_=${t}`;

/*** DOM + FORMAT HELPERS ***/
const $=(id)=>document.getElementById(id);
const nowUTC = ()=>new Date().toISOString().replace('T',' ').slice(0,16);
const round=(n,d=2)=>Number.isFinite(+n)?(+n).toFixed(d):"—";
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const nfGB = new Intl.NumberFormat('en-GB',{maximumFractionDigits:0});
const nfUS2 = new Intl.NumberFormat('en-US',{maximumFractionDigits:2});
const pct = (x,dp=2)=> Number.isFinite(+x) ? `${(+x).toFixed(dp)}%` : "—";
const bps = x => { if(!Number.isFinite(+x)) return "—";
  const v = +x;
  if (Math.abs(v) >= 0.1) return v.toFixed(2)+"%";
  if (Math.abs(v) >= 0.01) return v.toFixed(3)+"%";
  return v.toFixed(4)+"%";
};
function setPill(el,tone,text){ if(!el)return; el.textContent=text; el.className=`pill ${tone}`; }
function showError(m){const e=$("error");e.style.display="block";e.textContent=m;}
function hideError(){const e=$("error");e.style.display="none";}
function setNetNote(msg){$("netnote").textContent=msg||"";}

/*** TECHNICALS ***/
function sma(v,w){const o=Array(v.length).fill(null);let s=0;for(let i=0;i<v.length;i++){s+=v[i];if(i>=w)s-=v[i-w];if(i>=w-1)o[i]=s/w;}return o;}
function rsi(vals,len=14){
  if(vals.length<=len) return Array(vals.length).fill(null);
  const out=Array(vals.length).fill(null); let g=0,l=0;
  for(let i=1;i<=len;i++){const d=vals[i]-vals[i-1]; if(d>0)g+=d; else l-=d;}
  out[len]=100-(100/(1+(g/len)/((l/len)||1e-9)));
  for(let i=len+1;i<vals.length;i++){
    const d=vals[i]-vals[i-1],G=d>0?d:0,L=d<0?-d:0;
    g=(g*(len-1)+G)/len; l=(l*(len-1)+L)/len;
    out[i]=100-(100/(1+(g/(l||1e-9))));
  } return out;
}
const weeklyFromDaily = (c)=>{const w=[];for(let i=0;i<c.length;i+=7)w.push(c[i]);return w;};
const scoreToAngle = (s)=> -90+(clamp(s,0,10)/10)*180;
function setVerdict(s){
  let v="HOLD",cls="hold";
  if(s<=3.3){v="BUY";cls="buy"} else if(s>=6.7){v="SELL";cls="sell"}
  $("verdict").textContent=v; $("verdict").className=`verdict ${cls}`;
  setPill($("verdictPill"), cls==='buy'?'green':cls==='sell'?'red':'amber', v);
}

/*** HTTP: direct → auto-proxy fallback if CORS blocks ***/
async function getJSONAny(url, timeoutMs=10_000){
  try { return await getJSON(url, timeoutMs); }
  catch(e1){
    for(const p of PROXIES){
      try { return await getJSON(p + encodeURIComponent(url), timeoutMs); }
      catch(e2){ /* next */ }
    }
    throw e1;
  }
}
async function getJSON(url, timeoutMs=10_000){
  const ctl = new AbortController();
  const t = setTimeout(()=>ctl.abort(), timeoutMs);
  try{
    const r = await fetch(url, {signal: ctl.signal, cache: 'no-store'});
    if(!r.ok) throw new Error(`HTTP ${r.status} @ ${new URL(url.startsWith('http')?url:url).hostname}`);
    return await r.json();
  } finally { clearTimeout(t); }
}

/*** STATE ***/
let fxGBPperUSD = null;      // GBP from USD tick
let lastUSD = null;          // *** live USD cache (no DOM parsing) ***
let ws = null, wsOpen = false, lastTickTs = 0;

/*** LIVE PRICE VIA BINANCE WEBSOCKET (throttled) ***/
function openWS(){
  try{ if(ws) ws.close(); }catch{}
  ws = new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@trade");
  wsOpen = false;
  ws.onopen = ()=>{ wsOpen = true; };
  ws.onmessage = (ev)=>{
    const t = performance.now();
    if (t - lastTickTs < 250) return; // max 4 updates/sec
    lastTickTs = t;

    const data = JSON.parse(ev.data);
    const usd = Number(data.p);
    if(!Number.isFinite(usd)) return;
    lastUSD = usd; // keep in state
    const gbp = fxGBPperUSD ? usd * fxGBPperUSD : NaN;

    const gbpText = Number.isFinite(gbp) ? nfGB.format(gbp) : "—";
    const usdText = nfUS2.format(usd);
    $("price").textContent = `£ ${gbpText}  $ ${usdText}`;
    $("ts").textContent = nowUTC();
  };
document.addEventListener("visibilitychange", ()=>{
  if(document.hidden){ try{ ws && ws.close(); }catch{} }
  else if(!wsOpen){ openWS(); }
});

/*** FAST LOOP: 24h change + FX ratio (also seeds lastUSD) ***/
async function fastLoop(){
  try{
    hideError(); setNetNote("");
    const price = await getJSONAny(priceUrl());
    const liveUSD = price?.bitcoin?.usd;
    const liveGBP = price?.bitcoin?.gbp;
    const chg24   = price?.bitcoin?.usd_24h_change;

    if(Number.isFinite(liveUSD)) lastUSD = liveUSD;
    if(Number.isFinite(liveUSD) && Number.isFinite(liveGBP)){
      fxGBPperUSD = liveGBP / liveUSD;
    }
    $("change").textContent = `24h: ${(chg24>=0?"+":"")}${pct(chg24,2)}`;
  }catch(e){
    showError(e.message || String(e));
  }finally{
    setTimeout(fastLoop, FAST_MS);
  }
}

/*** SLOW LOOP: indicators + quick view ***/
async function slowLoop(){
  let next = SLOW_MS;
  try{
    hideError(); setNetNote("");
    const [chart, fund, fng] = await Promise.all([
      getJSONAny(chartUrl()),
      getJSONAny(fundUrl()).catch(()=>null),
      getJSONAny(fngUrl()).catch(()=>null),
    ]);

    if(fund===null || fng===null){ setNetNote("Note: some metrics blocked by your network — using best available."); }

    const closes = (chart?.prices || []).map(p=>p[1]).filter(Number.isFinite);
    if(closes.length < 200) throw new Error("Chart data too short for 200D MA");

    const i = closes.length - 1;
    const ma111 = sma(closes,111);
    const ma200 = sma(closes,200);
    const ma350 = sma(closes,350);

    // use last valid MA values and lastUSD (no DOM scraping)
    const lastNonNull = (arr)=>{ for(let j=arr.length-1;j>=0;j--){ if(Number.isFinite(arr[j])) return arr[j]; } return null; };
    const ma200v = Number.isFinite(ma200[i]) ? ma200[i] : lastNonNull(ma200);
    const ma111v = Number.isFinite(ma111[i]) ? ma111[i] : lastNonNull(ma111);
    const ma350v = Number.isFinite(ma350[i]) ? ma350[i] : lastNonNull(ma350);

    const priceNowUSD = Number.isFinite(lastUSD) ? lastUSD : closes[i];
    const dist200 = (Number.isFinite(ma200v) && Number.isFinite(priceNowUSD))
      ? (priceNowUSD/ma200v - 1)
      : 0;

    // RSI weekly
    const rsiWSeries = rsi(weeklyFromDaily(closes),14);
    const rsiW = rsiWSeries[rsiWSeries.length-1] ?? 50;

    // Pi-cycle spread (111 DMA vs 350 DMA * 2)
    let piText="—", piTone="amber";
    if(Number.isFinite(ma111v) && Number.isFinite(ma350v)){
      const spread = (ma111v/(ma350v*2) - 1)*100;
      piText = `${spread>=0?"+":""}${round(spread,1)}%`;
      piTone = spread>10 ? "red" : spread<-10 ? "green" : "amber";
    }

    // Funding (Binance)
    let fundText="—", fundTone="amber";
    if(Array.isArray(fund) && fund.length){
      const pctVal = Number(fund[0].fundingRate)*100;
      if(Number.isFinite(pctVal)){
        fundText = bps(pctVal);
        fundTone = pctVal>0.05?"red":pctVal<-0.05?"green":"amber";
      }
    } else if(fund===null){ fundText="— (blocked)"; fundTone="amber"; }

    // Fear & Greed
    let fgText="—", fgTone="amber";
    const fngVal = Number(fng?.data?.[0]?.value);
    if(Number.isFinite(fngVal)){
      fgText = `${fngVal} (${fng?.data?.[0]?.value_classification||""})`.trim();
      fgTone = fngVal>=75?"red":fngVal<=25?"green":"amber";
    } else if(fng===null){ fgText="— (blocked)"; fgTone="amber"; }

    // Heat score & verdict
    const sPi    = clamp((dist200*50),0,10);
    const sRsiW  = clamp(rsiW/10,0,10);
    const sTrend = clamp(priceNowUSD>ma200v?6+Math.min(dist200*20,4):4+Math.max(dist200*20,-4),0,10);
    const heat   = sPi*0.45 + sRsiW*0.35 + sTrend*0.20;

    // Cycle bar (robust)
    const HALVING = Date.UTC(2024,3,20); // 20 Apr 2024
    const days = Math.floor((Date.now()-HALVING)/86400000);
    const cycleAge = clamp(days/1470,0,1);
    const macro = clamp((dist200*200 + (rsiW||50))/2,0,100);
    const cycleScore = clamp((cycleAge*50) + (macro/2),0,100);

    // UI updates
    $("needle").setAttribute("transform", `rotate(${scoreToAngle(heat)},120,130)`);
    setVerdict(heat);

    const trendTone = dist200>0?"green":dist200<0?"red":"amber";
    const trendText = Number.isFinite(dist200)
      ? (dist200>0?`Up (${pct(dist200*100,1)})`:`Down (${pct(dist200*100,1)})`)
      : "—";
    setPill($("trend"), trendTone, trendText);
    setPill($("rsiw"), rsiW>70?"red":rsiW<30?"green":"amber", round(rsiW,1));
    setPill($("fund"), fundTone, fundText);
    setPill($("fg"),   fgTone,   fgText);
    setPill($("pi"),   piTone,   piText);

    $("cycleFill").style.width = `${Math.round(cycleScore)}%`;
  }catch(e){
    showError(e.message || String(e));
    setNetNote("Network hiccup — will retry shortly.");
    next = BACKOFF;
  }finally{
    setTimeout(slowLoop, next);
  }
}

/*** BOOT ***/
openWS();
fastLoop();
slowLoop();
</script>
</body>
</html>
